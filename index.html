<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JackBlack</title>
<link rel="icon" type="image/x-icon" href="/thumbnail.ico">
<link rel="icon" type="image/x-icon" href="/logo.ico">
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #1e1e1e;
    color: white;
    text-align: center;
    padding: 10px;
    max-width: 1000px;
    margin: 0 auto;
  }
  h1 { margin: 0 0 5px; font-size: 2em; }
  #game-message, #winner-message, #turn-indicator { margin-top: 5px; word-wrap: break-word; }
  #winner-message { font-size: 24px; font-weight: bold; color: #ffd700; }
  #turn-indicator { font-size: 18px; font-weight: bold; color: #ffd700; }
  #player-id-display { display: inline-block; font-size: 16px; font-weight: bold; color: #00ffff; background-color: rgba(0,0,0,0.3); padding: 3px 8px; border-radius: 10px; margin: 5px 0; max-width: 45%; overflow-wrap: break-word;}
  .card { display: inline-block; margin: 4px; padding: 15px 18px; background-color: #f0f0f0; border-radius: 10px; color: black; font-size: 20px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 2px solid #ccc; min-width: 35px; min-height: 50px; word-wrap: break-word;}
  button { padding: 8px 15px; font-size: 14px; margin: 4px; cursor: pointer; }
  #dealer-cards, #player-cards { display: flex; justify-content: center; align-items: center; margin: 10px 0; flex-wrap: wrap; }
  #player-cards-section, #dealer-cards-section { display: none; }
  input { padding: 8px; font-size: 14px; width: 130px; max-width: 80%; }
  .game-area { display: flex; flex-direction: column; gap: 10px; align-items: center; }
  .card-title { font-weight: bold; margin-top: 5px; }
  #player-info, #players-voting { font-size: 14px; margin: 5px 0; word-break: break-word; text-align:center;}
  @media (max-width: 700px) {
    body { padding: 5px; }
    h1 { font-size: 1.5em; }
    .card { font-size: 16px; padding: 10px 12px; min-width: 30px; min-height: 45px; }
    #player-id-display { font-size: 14px; max-width: 60%; }
    button { font-size: 12px; padding: 6px 10px; }
    input { font-size: 12px; width: 100px; }
    #game-message, #winner-message, #turn-indicator { font-size: 14px; }
  }
</style>
</head>
<body>

<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 5px;">
  <h1>JackBlack</h1>
  <div id="player-id-display">You are: waiting to join...</div>
</div>

<div>
  <button onclick="signIn()">Sign in with Google</button>
  <button onclick="signOut()">Sign out</button>
</div>

<div class="game-area">
  <div id="player-info"></div>
  <div id="players-voting"></div>

  <div style="margin: 5px 0;">
    <input id="room-id" placeholder="Enter Room ID">
    <button onclick="joinRoom()">Join Room</button>
    <button id="vote-button" onclick="voteToStart()" style="display:none;">Vote to Start</button>
  </div>

  <div id="turn-indicator"></div>

  <div id="controls" style="display:none;">
    <button onclick="hit()">Hit</button>
    <button onclick="stand()">Stand</button>
  </div>

  <div id="player-cards-section">
    <div class="card-title">Your Cards:</div>
    <div id="player-cards"></div>
  </div>

  <div id="dealer-cards-section">
    <div class="card-title">Dealer Cards:</div>
    <div id="dealer-cards"></div>
  </div>

  <div id="game-message"></div>
  <div id="winner-message"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

<script>
// initialize Firebase (no API keys on frontend)
firebase.initializeApp({});

// --- USER AUTH ---
let currentUser = null;
firebase.auth().onAuthStateChanged(user => {
  currentUser = user;
  const displayEl = document.getElementById("player-id-display");
  if(user){
    displayEl.textContent = `Signed in as: ${user.displayName}`;
  } else {
    displayEl.textContent = "You are not signed in.";
  }
});

async function signIn() {
  try {
    const res = await fetch('/api/signIn', { method: 'POST', credentials: 'include' });
    if (!res.ok) throw new Error('Sign-in failed');
    const data = await res.json();
    await firebase.auth().signInWithCustomToken(data.customToken);
  } catch (err) {
    console.error(err);
    alert('Sign-in failed: ' + err.message);
  }
}

function signOut() {
  firebase.auth().signOut();
}

// --- GAME LOGIC ---
const db = firebase.database();
let roomId="", playerId="", playerNames={};
const OWNER_UID = "qjapXZWARTfcosFi8sA5nC79jLq2";

const el={
  playerCards:document.getElementById("player-cards"),
  dealerCards:document.getElementById("dealer-cards"),
  gameMsg:document.getElementById("game-message"),
  winnerMsg:document.getElementById("winner-message"),
  turnIndicator:document.getElementById("turn-indicator"),
  controls:document.getElementById("controls"),
  voteBtn:document.getElementById("vote-button"),
  playerInfo:document.getElementById("player-info"),
  playersVoting:document.getElementById("players-voting"),
  playerIdDisplay:document.getElementById("player-id-display"),
  roomIdInput:document.getElementById("room-id")
};

function validateRoomId(rid){ return /^[a-zA-Z0-9]{3,20}$/.test(rid); }

function joinRoom(){
  if(!currentUser) return alert("Sign in first");
  roomId = el.roomIdInput.value.trim();
  if(!validateRoomId(roomId)) return alert("Room ID 3-20 chars");
  playerId = currentUser.uid;
  const playerRef = db.ref(`rooms/${roomId}/players/${playerId}`);
  playerRef.set({joined:Date.now(), vote:false, name:currentUser.displayName});
  playerRef.onDisconnect().remove();
  el.controls.style.display="block";
  el.voteBtn.style.display="inline-block";
  db.ref(`rooms/${roomId}/game`).on('value', updateGameState);
  db.ref(`rooms/${roomId}/players`).on('value', updatePlayers);
}

// --- PLAYER VOTING ---
function updatePlayers(snap){
  const players = snap.val()||{};
  playerNames = {};
  for(const pid in players) playerNames[pid] = pid===OWNER_UID?`👑 ${players[pid].name}`:players[pid].name||pid;
  const playerIds = Object.keys(players);
  el.playerInfo.innerText = "Players: "+playerIds.map(pid=>`${playerNames[pid]} [${players[pid].vote?"✓":"✗"}]`).join(", ");
  const votesCount = Object.values(players).filter(p=>p.vote).length;
  el.playersVoting.innerText = `${votesCount}/${playerIds.length} voted to start.`;
  if(playerIds.length>0 && votesCount===playerIds.length){
    const sortedIds=[...playerIds].sort();
    if(playerId===sortedIds[0]) startGame(playerIds);
  }
}

function voteToStart(){ 
  db.ref(`rooms/${roomId}/players/${playerId}`).update({vote:true});
  el.voteBtn.style.display="none";
}

// --- GAME FUNCTIONS ---
function startGame(playerIds){
  const suits=['♠','♣','♦','♥'], values=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
  let deck=[];
  for(let s of suits) for(let v of values) deck.push({v,s});
  deck.sort(()=>Math.random()-0.5);
  const shuffledIds=[...playerIds].sort(()=>Math.random()-0.5);
  const gameState={
    deck,
    playerHands:{},
    dealerHand:[deck.pop(),deck.pop()],
    turn:shuffledIds[0],
    message:"Game started!",
    winnerMessage:"",
    stood:{},
    busted:{},
    over:false,
    playerOrder:shuffledIds
  };
  for(let pid of shuffledIds){
    gameState.playerHands[pid] = [deck.pop(), deck.pop()];
    if(calcScore(gameState.playerHands[pid])===21){
      const pname = playerNames[pid] || "Dealer";
      gameState.message=`${pname} has blackjack!`;
      gameState.winnerMessage=`🏆 ${pname} WON WITH JACKBLACK! 🏆`;
      gameState.winner = pid;
      gameState.over = true;
    }
  }
  db.ref(`rooms/${roomId}/game`).set(gameState);
  el.voteBtn.style.display="none";
}

function updateGameState(snap){
  const game = snap.val(); if(!game) return;
  document.getElementById("player-cards-section").style.display="block";
  document.getElementById("dealer-cards-section").style.display="block";
  const playerHand = game.playerHands?.[playerId]||[];
  const dealerHand = game.dealerHand||[];
  updateCards(el.playerCards, playerHand);
  updateCards(el.dealerCards, !game.over && game.turn!=='dealer'? [dealerHand[0],'?'] : dealerHand);
  el.turnIndicator.innerText = game.over && game.winnerMessage?`Game Over!`:`Turn: ${playerNames[game.turn]||game.turn}`;
  el.gameMsg.innerText = game.message;
  el.winnerMsg.innerText = game.winnerMessage||"";
}

function updateCards(container, cards){
  container.innerHTML = "";
  for(let c of cards){
    const div = document.createElement("div"); div.className="card"; div.innerText=c.v+c.s||c; container.appendChild(div);
  }
}

function calcScore(cards){
  let sum=0, aces=0;
  for(let c of cards){
    if(c.v==='A'){ sum+=11; aces++; }
    else if(['J','Q','K'].includes(c.v)) sum+=10;
    else sum+=parseInt(c.v);
  }
  while(sum>21 && aces>0){ sum-=10; aces--; }
  return sum;
}

function hit(){
  db.ref(`rooms/${roomId}/game`).once('value').then(snap=>{
    const game = snap.val(); if(!game || game.over) return;
    if(game.turn!==playerId) return alert("Not your turn!");
    const card = game.deck.pop();
    game.playerHands[playerId].push(card);
    const score = calcScore(game.playerHands[playerId]);
    game.message = `${playerNames[playerId]} drew ${card.v}${card.s} (Total: ${score})`;
    if(score>21){ game.busted[playerId]=true; game.message = `${playerNames[playerId]} busted!`; nextTurn(game); }
    db.ref(`rooms/${roomId}/game`).set(game);
  });
}

function stand(){
  db.ref(`rooms/${roomId}/game`).once('value').then(snap=>{
    const game = snap.val(); if(!game || game.over) return;
    if(game.turn!==playerId) return alert("Not your turn!");
    game.stood[playerId]=true;
    game.message = `${playerNames[playerId]} stands.`;
    nextTurn(game);
    db.ref(`rooms/${roomId}/game`).set(game);
  });
}

function nextTurn(game){
  const idx = game.playerOrder.indexOf(game.turn);
  let nextIdx = idx+1;
  while(nextIdx<game.playerOrder.length){
    const pid = game.playerOrder[nextIdx];
    if(!game.stood[pid] && !game.busted[pid]) break;
    nextIdx++;
  }
  if(nextIdx>=game.playerOrder.length){
    game.turn = "dealer"; dealerPlay(game);
  } else game.turn = game.playerOrder[nextIdx];
}

function dealerPlay(game){
  let dealerScore = calcScore(game.dealerHand);
  while(dealerScore<17){
    const card = game.deck.pop();
    game.dealerHand.push(card);
    dealerScore = calcScore(game.dealerHand);
  }
  // Determine winner
  const playerScores = {};
  for(let pid of game.playerOrder){
    const score = calcScore(game.playerHands[pid]);
    if(score>21) playerScores[pid]=0; else playerScores[pid]=score;
  }
  let maxScore = Math.max(...Object.values(playerScores), dealerScore);
  let winners = [];
  for(let pid in playerScores) if(playerScores[pid]===maxScore) winners.push(playerNames[pid]||pid);
  if(dealerScore===maxScore) winners.push("Dealer");
  game.winnerMessage = winners.join(", ")+" won!";
  game.over=true;
  game.message="Game over!";
  db.ref(`rooms/${roomId}/game`).set(game);
}
</script>
</body>
</html>
