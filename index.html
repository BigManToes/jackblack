<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JackBlack</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: white;
      text-align: center;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      margin-top: 0;
      margin-bottom: 5px;
    }
    #game-message, #players-voting, #player-info {
      margin-top: 5px;
      font-size: 14px;
    }
    #game-message {
      font-size: 18px;
      margin-top: 10px;
    }
    #winner-message {
      margin-top: 5px;
      font-size: 28px;
      font-weight: bold;
      color: #ffd700;
    }
    #turn-indicator {
      margin: 5px 0;
      font-size: 20px;
      font-weight: bold;
      color: #ffd700;
    }
    #player-id-display {
      display: inline-block;
      font-size: 18px;
      font-weight: bold;
      color: #00ffff;
      background-color: rgba(0,0,0,0.3);
      padding: 3px 10px;
      border-radius: 10px;
      margin: 5px 0;
    }
    .card {
      display: inline-block;
      margin: 5px;
      padding: 20px 25px;
      background-color: #f0f0f0;
      border-radius: 10px;
      color: black;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border: 2px solid #ccc;
      min-width: 40px;
      min-height: 60px;
      user-select: none;
    }
    button {
      padding: 8px 15px;
      font-size: 14px;
      margin: 5px;
      cursor: pointer;
    }
    #dealer-cards, #player-cards {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    input {
      padding: 8px;
      font-size: 14px;
    }
    .game-area {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .card-section {
      font-weight: bold;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
    <h1>JackBlack</h1>
    <div id="player-id-display">You are: waiting to join...</div>
  </div>
  
  <div class="game-area">
    <div id="player-info"></div>
    <div id="players-voting"></div>
    
    <div style="margin: 5px 0;">
      <input id="room-id" placeholder="Enter Room ID" style="width: 150px;" />
      <button id="join-btn" onclick="joinRoom()">Join Room</button>
      <button id="vote-button" onclick="voteToStart()" style="display:none;">Vote to Start</button>
    </div>
    
    <div id="turn-indicator"></div>
    
    <div id="controls" style="display:none;">
      <button id="hit-btn" onclick="hit()">Hit</button>
      <button id="stand-btn" onclick="stand()">Stand</button>
    </div>
    
    <div>
      <div class="card-section">Your Cards:</div>
      <div id="player-cards"></div>
    </div>
    
    <div>
      <div class="card-section">Dealer Cards:</div>
      <div id="dealer-cards"></div>
    </div>
    
    <div id="game-message"></div>
    <div id="winner-message"></div>
  </div>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

  <script>
    // Initialize app variables
    const firebaseConfig = {
      apiKey: "AIzaSyBVajydbsrNT6bJOCNMNjJZc4NXvGy42SQ",
      authDomain: "jackblack-789f5.firebaseapp.com",
      databaseURL: "https://jackblack-789f5-default-rtdb.firebaseio.com",
      projectId: "jackblack-789f5",
      storageBucket: "jackblack-789f5.firebasestorage.app",
      messagingSenderId: "14557094808",
      appId: "1:14557094808:web:252134996948616d95c1ed",
      measurementId: "G-89GFJPNWKH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Cache DOM elements
    const elements = {
      playerIdDisplay: document.getElementById("player-id-display"),
      controls: document.getElementById("controls"),
      voteButton: document.getElementById("vote-button"),
      playerInfo: document.getElementById("player-info"),
      playersVoting: document.getElementById("players-voting"),
      turnIndicator: document.getElementById("turn-indicator"),
      gameMessage: document.getElementById("game-message"),
      winnerMessage: document.getElementById("winner-message"),
      playerCards: document.getElementById("player-cards"),
      dealerCards: document.getElementById("dealer-cards"),
      roomId: document.getElementById("room-id")
    };

    // Game state
    let roomId = "";
    let playerId = "player" + Math.floor(Math.random() * 1000);
    
    // Set initial player ID
    elements.playerIdDisplay.textContent = `You are: ${playerId}`;

    // Game constants
    const CARD_SUITS = ['♠', '♣', '♦', '♥'];
    const CARD_VALUES = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const DEALER_MIN = 17;
    
    function joinRoom() {
      roomId = elements.roomId.value.trim();
      if (!roomId) return alert("Enter room ID!");

      const playerRef = db.ref(`rooms/${roomId}/players/${playerId}`);
      playerRef.set({ joined: Date.now(), vote: false });
      playerRef.onDisconnect().remove();

      elements.controls.style.display = "block";
      elements.voteButton.style.display = "inline-block";
      elements.playerIdDisplay.textContent = `You: ${playerId} (Room: ${roomId})`;
      listenForUpdates();
    }

    function listenForUpdates() {
      db.ref(`rooms/${roomId}/game`).on('value', handleGameUpdate);
      db.ref(`rooms/${roomId}/players`).on('value', handlePlayersUpdate);
    }

    function handleGameUpdate(snap) {
      const game = snap.val();
      if (!game) return;

      const playerHand = game.playerHands?.[playerId] || [];
      const dealerHand = game.dealerHand || [];
      const isPlayerTurn = game.turn === playerId && !game.over;

      updateCards(elements.playerCards, playerHand);

      // Show dealer's first card and hide others if game not over and dealer's turn hasn't started
      const showDealerHand = (!game.over && game.turn !== "dealer") 
        ? [dealerHand[0], ...dealerHand.slice(1).map(() => ({ v: "??", s: "?" }))]
        : dealerHand;
      
      updateCards(elements.dealerCards, showDealerHand);
      
      elements.gameMessage.innerText = game.message || "";
      elements.winnerMessage.innerText = game.winnerMessage || "";
      elements.controls.style.display = isPlayerTurn ? "block" : "none";

      // Turn indicator
      if (game.over) {
        elements.turnIndicator.innerText = "Game Over";
      } else if (game.turn === "dealer") {
        elements.turnIndicator.innerText = "Dealer's Turn";
      } else if (game.turn) {
        elements.turnIndicator.innerText = game.turn === playerId ? "YOUR TURN!" : `${game.turn}'s turn`;
      } else {
        elements.turnIndicator.innerText = "";
      }
    }

    function handlePlayersUpdate(snap) {
      const players = snap.val() || {};
      const playerIds = Object.keys(players);
      
      // Build player list with vote status
      const playerList = playerIds.map(pid => {
        const isCurrentPlayer = pid === playerId;
        const voteStatus = players[pid].vote ? "✓" : "✗";
        return `${isCurrentPlayer ? "YOU" : ""} ${isCurrentPlayer ? "" : pid} [${voteStatus}]`;
      }).join(", ");
      
      elements.playerInfo.innerText = `Players: ${playerList}`;

      // Voting stats
      const votesCount = Object.values(players).filter(p => p.vote).length;
      elements.playersVoting.innerText = `${votesCount}/${playerIds.length} voted to start.`;

      // Start game when everyone has voted
      if (playerIds.length >= 2 && votesCount === playerIds.length) {
        const sortedIds = playerIds.slice().sort();
        if (playerId === sortedIds[0]) {
          startGame(playerIds);
        }
      }
    }

    function startGame(playerIds) {
      // Create and shuffle deck
      let deck = [];
      for (let s of CARD_SUITS) {
        for (let v of CARD_VALUES) {
          deck.push({ v, s });
        }
      }
      shuffleDeck(deck);

      // Randomize player order
      const shuffledIds = shuffleArray([...playerIds]);

      // Create initial game state
      const gameState = {
        deck,
        playerHands: {},
        dealerHand: [deck.pop(), deck.pop()],
        turn: shuffledIds[0],
        message: "Game started!",
        winnerMessage: "",
        players: {},
        stood: {},
        busted: {},
        over: false,
        playerOrder: shuffledIds
      };

      // Deal cards to players and check for blackjacks
      for (let pid of shuffledIds) {
        gameState.playerHands[pid] = [deck.pop(), deck.pop()];
        gameState.players[pid] = { vote: true };
        
        const score = calcScore(gameState.playerHands[pid]);
        if (score === 21) {
          gameState.message = `${pid} has blackjack (21)!`;
          gameState.winnerMessage = `🏆 ${pid} WINS WITH BLACKJACK! 🏆`;
          gameState.winner = pid;
          gameState.over = true;
        }
      }

      // Save game state to database
      db.ref(`rooms/${roomId}/game`).set(gameState);
      elements.voteButton.style.display = "none";
    }

    function voteToStart() {
      db.ref(`rooms/${roomId}/players/${playerId}`).update({ vote: true });
      elements.voteButton.style.display = "none";
    }

    function updateCards(container, cards) {
      container.innerHTML = "";
      cards.forEach(card => {
        const el = document.createElement("div");
        el.className = "card";
        el.innerText = `${card.v} ${card.s}`;
        container.appendChild(el);
      });
    }

    function hit() {
      db.ref(`rooms/${roomId}/game`).once('value', snap => {
        const game = snap.val();
        if (game.turn !== playerId || game.over) return;
        if ((game.stood && game.stood[playerId]) || (game.busted && game.busted[playerId])) return;

        // Draw a card and add to player's hand
        const deck = game.deck;
        const newCard = deck.pop();
        game.playerHands[playerId].push(newCard);

        const score = calcScore(game.playerHands[playerId]);
        
        // Handle bust or 21
        if (score > 21) {
          game.message = `${playerId} BUSTED with ${score}!`;
          game.busted = game.busted || {};
          game.busted[playerId] = true;
        } else if (score === 21) {
          game.message = `${playerId} hits 21!`;
          game.stood = game.stood || {};
          game.stood[playerId] = true;
        } else {
          game.message = `${playerId} hits. Score: ${score}`;
        }

        game.deck = deck;

        // Check if all players are done
        if (checkAllPlayersDone(game)) {
          moveToDealer(game);
        } else {
          moveToNextPlayer(game, playerId);
        }
        
        // Save game state
        db.ref(`rooms/${roomId}/game`).set(game);
      });
    }

    function stand() {
      db.ref(`rooms/${roomId}/game`).once('value', snap => {
        const game = snap.val();
        if (game.turn !== playerId || game.over) return;
        if ((game.stood && game.stood[playerId]) || (game.busted && game.busted[playerId])) return;

        // Mark player as stood
        game.message = `${playerId} stands.`;
        game.stood = game.stood || {};
        game.stood[playerId] = true;

        // Check if all players are done
        if (checkAllPlayersDone(game)) {
          moveToDealer(game);
        } else {
          moveToNextPlayer(game, playerId);
        }
        
        // Save game state
        db.ref(`rooms/${roomId}/game`).set(game);
      });
    }

    function checkAllPlayersDone(game) {
      return Object.keys(game.playerHands).every(pid =>
        (game.stood && game.stood[pid]) ||
        (game.busted && game.busted[pid]) ||
        calcScore(game.playerHands[pid]) === 21
      );
    }

    function moveToDealer(game) {
      game.turn = "dealer";
      game.message += " Dealer's turn!";
      setTimeout(() => dealerPlay(), 1000);
    }

    function moveToNextPlayer(game, currentId) {
      const nextPlayer = getNextPlayer(game, currentId);
      if (nextPlayer) {
        game.turn = nextPlayer;
      }
    }

    function getNextPlayer(game, currentId) {
      const playerIds = game.playerOrder || Object.keys(game.playerHands);
      const idx = playerIds.indexOf(currentId);
      
      for (let i = 1; i < playerIds.length; i++) {
        const nextIdx = (idx + i) % playerIds.length;
        const nextId = playerIds[nextIdx];
        
        // Skip players who are busted, stood, or have 21
        if (
          !(game.busted && game.busted[nextId]) &&
          !(game.stood && game.stood[nextId]) &&
          calcScore(game.playerHands[nextId]) < 21
        ) {
          return nextId;
        }
      }
      return null;
    }

    function dealerPlay() {
      db.ref(`rooms/${roomId}/game`).once('value', snap => {
        const game = snap.val();
        if (!game || game.over || game.turn !== "dealer") return;

        let dealerHand = game.dealerHand || [];
        let deck = game.deck || [];
        
        // Check if all players busted - dealer automatically wins
        const allPlayersBusted = Object.keys(game.playerHands).every(pid => 
          game.busted && game.busted[pid]);
          
        if (allPlayersBusted) {
          game.message = "All players busted! Dealer wins.";
          game.winnerMessage = "Dealer wins!";
          game.over = true;
          db.ref(`rooms/${roomId}/game`).set(game);
          return;
        }

        // Dealer hits until 17 or more
        let dealerScore = calcScore(dealerHand);
        while (dealerScore < DEALER_MIN) {
          dealerHand.push(deck.pop());
          dealerScore = calcScore(dealerHand);
        }

        game.dealerHand = dealerHand;
        game.deck = deck;
        game.over = true;

        // Determine winner
        const results = determineWinner(game);
        game.message = "Dealer has " + dealerScore + results.message;
        game.winnerMessage = results.winnerMessage;
        game.winner = results.winner;

        db.ref(`rooms/${roomId}/game`).set(game);
      });
    }

    function determineWinner(game) {
      const dealerScore = calcScore(game.dealerHand);
      const dealerBusted = dealerScore > 21;
      
      let message = dealerBusted ? " (BUSTED)!" : ".";
      let winnerMessage = "";
      let winner = null;
      
      // If dealer busted, all non-busted players win
      if (dealerBusted) {
        const winners = Object.keys(game.playerHands).filter(pid => 
          !(game.busted && game.busted[pid])
        );
        
        if (winners.length > 0) {
          if (winners.length === 1) {
            winner = winners[0];
            winnerMessage = `🏆 ${winner} WINS! Dealer busted. 🏆`;
          } else {
            winnerMessage = `Winners: ${winners.join(", ")}. Dealer busted.`;
          }
        } else {
          message += " Everyone busted! No winner.";
        }
      } else {
        // Dealer didn't bust, compare scores
        const results = [];
        let bestPlayer = null;
        let bestScore = dealerScore;
        
        for (const pid of game.playerOrder || Object.keys(game.playerHands)) {
          if (game.busted && game.busted[pid]) continue;
          
          const playerScore = calcScore(game.playerHands[pid]);
          
          if (playerScore > dealerScore && playerScore <= 21) {
            if (playerScore > bestScore) {
              bestScore = playerScore;
              bestPlayer = pid;
            }
            results.push(`${pid} wins with ${playerScore}`);
          } else if (playerScore === dealerScore) {
            results.push(`${pid} tied with dealer (${playerScore})`);
          } else {
            results.push(`${pid} lost with ${playerScore}`);
          }
        }
        
        if (bestPlayer) {
          winner = bestPlayer;
          winnerMessage = `🏆 ${bestPlayer} WINS WITH ${bestScore}! 🏆`;
        } else if (results.some(r => r.includes("tied"))) {
          winnerMessage = "Tied with dealer!";
        } else {
          winnerMessage = "Dealer wins!";
        }
        
        message += " " + results.join(". ");
      }
      
      // Highlight if current player is the winner
      if (winner === playerId) {
        winnerMessage = `🏆 YOU (${playerId}) WIN! 🏆`;
      }
      
      return { message, winnerMessage, winner };
    }

    // Utility functions
    function calcScore(hand) {
      let score = 0, aces = 0;
      
      for (const card of hand) {
        if (['J', 'Q', 'K'].includes(card.v)) {
          score += 10;
        } else if (card.v === 'A') {
          score += 11;
          aces++;
        } else {
          score += parseInt(card.v);
        }
      }
      
      // Adjust aces if needed
      while (score > 21 && aces > 0) {
        score -= 10;
        aces--;
      }
      
      return score;
    }
    
    function shuffleDeck(deck) {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }
    
    function shuffleArray(array) {
      return [...array].sort(() => Math.random() - 0.5);
    }
  </script>
</body>
</html>
