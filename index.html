<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JackBlack Multiplayer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: white;
      text-align: center;
      padding: 50px;
    }
    #game-message {
      margin-top: 20px;
      font-size: 20px;
    }
    .card {
      display: inline-block;
      margin: 10px;
      padding: 10px 15px;
      background-color: #f0f0f0;
      border-radius: 10px;
      color: black;
      font-size: 18px;
    }
    button {
      padding: 15px 30px;
      font-size: 18px;
      margin: 20px;
      cursor: pointer;
    }
    #player-cards {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    input {
      padding: 10px;
      font-size: 16px;
    }
    #player-info {
      font-size: 18px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>JackBlack Multiplayer</h1>
  <p>Join a room to play blackjack in real-time!</p>
  <div id="player-info"></div>
  <input id="room-id" placeholder="Enter Room ID" />
  <button id="join-room-button" onclick="joinRoom()">Join Room</button>

  <div id="controls" style="display:none;">
    <button id="vote-button" onclick="voteToStart()">Vote to Start</button>
    <button id="hit-button" onclick="hit()" style="display:none;">Hit</button>
    <button id="stand-button" onclick="stand()" style="display:none;">Stand</button>
  </div>

  <div id="player-cards"></div>
  <div id="game-message"></div>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomId = "";
    let playerId = "player" + Math.floor(Math.random() * 1000);
    let isPlayerTurn = false;

    function joinRoom() {
      roomId = document.getElementById("room-id").value.trim();
      if (!roomId) return alert("Enter room ID!");
      const roomRef = db.ref(`rooms/${roomId}`);

      roomRef.child("players").once("value", snap => {
        const players = snap.val() || {};
        const playerCount = Object.keys(players).length;

        if (playerCount >= 2) {
          alert("Room is full! Max 2 players allowed.");
          return;
        }

        // Add player
        db.ref(`rooms/${roomId}/players/${playerId}`).set({
          vote: false,
          joined: Date.now()
        });
        db.ref(`rooms/${roomId}/players/${playerId}`).onDisconnect().remove();

        document.getElementById("player-info").innerText = `You are ${playerId}`;
        document.getElementById("controls").style.display = "block";

        listenForVotes();
        listenForGame();
      });
    }

    function voteToStart() {
      db.ref(`rooms/${roomId}/players/${playerId}`).update({ vote: true });
    }

    function listenForVotes() {
      db.ref(`rooms/${roomId}/players`).on("value", snap => {
        const players = snap.val() || {};
        const ids = Object.keys(players);
        if (ids.length !== 2) {
          document.getElementById("game-message").innerText = `Waiting for players... (${ids.length}/2 joined)`;
          return;
        }

        const votes = ids.filter(id => players[id].vote).length;
        document.getElementById("game-message").innerText = `${votes} out of 2 voted to start.`;

        if (votes === 2) {
          startGame(ids);
        }
      });
    }

    function startGame(playerIds) {
      const suits = ['♠', '♣', '♦', '♥'];
      const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
      let deck = [];

      for (let s of suits) for (let v of values) deck.push({ v, s });
      deck = deck.sort(() => Math.random() - 0.5);

      const playerHands = {};
      for (let pid of playerIds) {
        playerHands[pid] = [deck.pop(), deck.pop()];
      }

      const game = {
        deck,
        playerHands,
        turn: playerIds[0],
        message: "Game started!",
        over: false
      };

      db.ref(`rooms/${roomId}/game`).set(game);

      // Clear votes
      playerIds.forEach(pid => {
        db.ref(`rooms/${roomId}/players/${pid}/vote`).set(false);
      });

      document.getElementById("vote-button").style.display = "none";
    }

    function listenForGame() {
      db.ref(`rooms/${roomId}/game`).on("value", snap => {
        const game = snap.val();
        if (!game) return;

        const hand = game.playerHands?.[playerId] || [];
        updateCards("player-cards", hand);

        document.getElementById("game-message").innerText = game.message || "";
        isPlayerTurn = game.turn === playerId;

        document.getElementById("hit-button").style.display = isPlayerTurn ? "inline-block" : "none";
        document.getElementById("stand-button").style.display = isPlayerTurn ? "inline-block" : "none";
      });
    }

    function hit() {
      db.ref(`rooms/${roomId}/game`).once("value", snap => {
        const game = snap.val();
        if (!game || game.turn !== playerId || game.over) return;

        const newCard = game.deck.pop();
        game.playerHands[playerId].push(newCard);

        const score = calcScore(game.playerHands[playerId]);
        game.message = `${playerId} hits. Score: ${score}`;

        if (score > 21) {
          game.message = `${playerId} busted!`;
          game.over = true;
        } else {
          const other = Object.keys(game.playerHands).find(p => p !== playerId);
          game.turn = other;
        }

        db.ref(`rooms/${roomId}/game`).set(game);
      });
    }

    function stand() {
      db.ref(`rooms/${roomId}/game`).once("value", snap => {
        const game = snap.val();
        if (!game || game.turn !== playerId || game.over) return;

        game.message = `${playerId} stands.`;
        const other = Object.keys(game.playerHands).find(p => p !== playerId);
        game.turn = other;

        db.ref(`rooms/${roomId}/game`).set(game);
      });
    }

    function calcScore(hand) {
      let score = 0, aces = 0;
      hand.forEach(c => {
        if (['J','Q','K'].includes(c.v)) score += 10;
        else if (c.v === 'A') {
          score += 11;
          aces++;
        } else score += parseInt(c.v);
      });
      while (score > 21 && aces) {
        score -= 10;
        aces--;
      }
      return score;
    }

    function updateCards(id, cards) {
      const div = document.getElementById(id);
      div.innerHTML = "";
      cards.forEach(card => {
        const el = document.createElement("div");
        el.className = "card";
        el.innerText = `${card.v} ${card.s}`;
        div.appendChild(el);
      });
    }
  </script>
</body>
</html>
