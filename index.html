<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JackBlack</title>
<link rel="icon" type="image/x-icon" href="/thumbnail.ico">
<link rel="icon" type="image/x-icon" href="/logo.ico">
<style>
body { font-family: Arial, sans-serif; background-color: #1e1e1e; color: white; text-align: center; padding: 10px; max-width: 1000px; margin: 0 auto;}
h1 { margin: 0 0 5px; font-size: 2em; }
#game-message, #winner-message, #turn-indicator { word-wrap: break-word; margin: 5px 0; }
#player-id-display { display: inline-block; font-size: 16px; font-weight: bold; color: #00ffff; background-color: rgba(0,0,0,0.3); padding: 3px 8px; border-radius: 10px; margin: 5px 0; max-width: 45%; overflow-wrap: break-word;}
.card { display: inline-block; margin: 4px; padding: 15px 18px; background-color: #f0f0f0; border-radius: 10px; color: black; font-size: 20px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 2px solid #ccc; min-width: 35px; min-height: 50px; word-wrap: break-word;}
button { padding: 8px 15px; font-size: 14px; margin: 4px; cursor: pointer;}
#dealer-cards, #player-cards { display: flex; justify-content: center; align-items: center; margin: 10px 0; flex-wrap: wrap; }
#player-cards-section, #dealer-cards-section { display: none; }
input { padding: 8px; font-size: 14px; width: 130px; max-width: 80%; }
.game-area { display: flex; flex-direction: column; gap: 10px; align-items: center; }
.card-title { font-weight: bold; margin-top: 5px; }
#player-info, #players-voting { font-size: 14px; margin: 5px 0; text-align:center;}
@media (max-width: 700px) {
  body { padding: 5px; }
  h1 { font-size: 1.5em; }
  .card { font-size: 16px; padding: 10px 12px; min-width: 30px; min-height: 45px; }
  #player-id-display { font-size: 14px; max-width: 60%; }
  button { font-size: 12px; padding: 6px 10px; }
  input { font-size: 12px; width: 100px; }
  #game-message, #winner-message, #turn-indicator { font-size: 14px; }
}
</style>
</head>
<body>
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 5px;">
  <h1>JackBlack</h1>
  <div id="player-id-display">You are: waiting to join...</div>
</div>

<div>
  <button id="sign-in-btn">Sign in with Google</button>
  <button id="sign-out-btn">Sign out</button>
</div>

<div class="game-area">
  <div id="player-info"></div>
  <div id="players-voting"></div>

  <div style="margin: 5px 0;">
    <input id="room-id" placeholder="Enter Room ID">
    <button id="join-room-btn">Join Room</button>
    <button id="vote-button" style="display:none;">Vote to Start</button>
  </div>

  <div id="turn-indicator"></div>

  <div id="controls" style="display:none;">
    <button id="hit-btn">Hit</button>
    <button id="stand-btn">Stand</button>
  </div>

  <div id="player-cards-section">
    <div class="card-title">Your Cards:</div>
    <div id="player-cards"></div>
  </div>

  <div id="dealer-cards-section">
    <div class="card-title">Dealer Cards:</div>
    <div id="dealer-cards"></div>
  </div>

  <div id="game-message"></div>
  <div id="winner-message"></div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

<script>
// Get Firebase config from backend
async function getFirebaseConfig() {
  const res = await fetch('/api/config');
  if (!res.ok) throw new Error('Could not fetch Firebase config');
  return res.json();
}

async function initApp() {
  const config = await getFirebaseConfig();
  firebase.initializeApp(config);

  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  const OWNER_UID = "qjapXZWARTfcosFi8sA5nC79jLq2";

  const el = {
    playerIdDisplay: document.getElementById("player-id-display"),
    signInBtn: document.getElementById("sign-in-btn"),
    signOutBtn: document.getElementById("sign-out-btn"),
    joinRoomBtn: document.getElementById("join-room-btn"),
    voteBtn: document.getElementById("vote-button"),
    controls: document.getElementById("controls"),
    playerCards: document.getElementById("player-cards"),
    dealerCards: document.getElementById("dealer-cards"),
    gameMsg: document.getElementById("game-message"),
    winnerMsg: document.getElementById("winner-message"),
    turnIndicator: document.getElementById("turn-indicator"),
    playerInfo: document.getElementById("player-info"),
    playersVoting: document.getElementById("players-voting"),
    roomIdInput: document.getElementById("room-id")
  };

  // --- Authentication ---
  el.signInBtn.onclick = async () => {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    } catch (e) {
      alert("Sign-in failed: " + e.message);
    }
  };

  el.signOutBtn.onclick = async () => { await auth.signOut(); };

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      el.playerIdDisplay.textContent = user.uid === OWNER_UID ? `ðŸ‘‘ Owner: ${user.displayName}` : `Signed in as: ${user.displayName}`;
    } else { el.playerIdDisplay.textContent = "You are not signed in."; }
  });

  // --- Game logic ---
  let roomId = "", playerId = "", playerNames = {};

  function validateRoomId(rid){ return /^[a-zA-Z0-9]{3,20}$/.test(rid); }

  el.joinRoomBtn.onclick = () => {
    if (!currentUser) return alert("Sign in first");
    roomId = el.roomIdInput.value.trim();
    if (!validateRoomId(roomId)) return alert("Room ID 3-20 chars");
    playerId = currentUser.uid;
    const playerRef = db.ref(`rooms/${roomId}/players/${playerId}`);
    playerRef.set({joined: Date.now(), vote:false, name:currentUser.displayName});
    playerRef.onDisconnect().remove();
    el.controls.style.display="block";
    el.voteBtn.style.display="inline-block";

    db.ref(`rooms/${roomId}/game`).on('value', updateGameState);
    db.ref(`rooms/${roomId}/players`).on('value', updatePlayers);
  };

  el.voteBtn.onclick = () => {
    db.ref(`rooms/${roomId}/players/${playerId}`).update({vote:true});
    el.voteBtn.style.display="none";
  };

  function updatePlayers(snap) {
    const players = snap.val() || {};
    playerNames = {};
    for (const pid in players) playerNames[pid] = pid === OWNER_UID ? `ðŸ‘‘ ${players[pid].name}` : players[pid].name || pid;
    const playerIds = Object.keys(players);
    el.playerInfo.innerText = "Players: " + playerIds.map(pid => `${playerNames[pid]} [${players[pid].vote?"âœ“":"âœ—"}]`).join(", ");
    const votesCount = Object.values(players).filter(p=>p.vote).length;
    el.playersVoting.innerText = `${votesCount}/${playerIds.length} voted to start.`;
    if (playerIds.length > 0 && votesCount === playerIds.length) {
      const sortedIds = [...playerIds].sort();
      if (playerId === sortedIds[0]) startGame(playerIds);
    }
  }

  function startGame(playerIds) {
    const suits = ['â™ ','â™£','â™¦','â™¥'], values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    let deck=[];
    for(let s of suits) for(let v of values) deck.push({v,s});
    deck.sort(()=>Math.random()-0.5);
    const shuffledIds = [...playerIds].sort(()=>Math.random()-0.5);
    const gameState = {
      deck,
      playerHands:{},
      dealerHand:[deck.pop(),deck.pop()],
      turnIndex:0,
      playerOrder:shuffledIds
    };
    for(let pid of playerIds) gameState.playerHands[pid] = [deck.pop(),deck.pop()];
    db.ref(`rooms/${roomId}/game`).set(gameState);
  }

  function updateGameState(snap) {
    const game = snap.val();
    if(!game) return;
    const hand = game.playerHands[playerId] || [];
    el.playerCards.innerHTML = hand.map(c=>`<div class="card">${c.v}${c.s}</div>`).join("");
    el.dealerCards.innerHTML = game.dealerHand.map(c=>`<div class="card">${c.v}${c.s}</div>`).join("");
    el.turnIndicator.innerText = `Turn: ${playerNames[game.playerOrder[game.turnIndex]] || game.playerOrder[game.turnIndex]}`;
  }

  // Controls for hit/stand
  el.controls.querySelector("#hit-btn").onclick = () => {
    db.ref(`rooms/${roomId}/game`).once('value').then(snap=>{
      const g = snap.val(); if(!g) return;
      const hand = g.playerHands[playerId]; if(!hand) return;
      hand.push(g.deck.pop());
      db.ref(`rooms/${roomId}/game/playerHands/${playerId}`).set(hand);
    });
  };

  el.controls.querySelector("#stand-btn").onclick = () => {
    db.ref(`rooms/${roomId}/game`).once('value').then(snap=>{
      const g = snap.val(); if(!g) return;
      g.turnIndex = (g.turnIndex+1)%g.playerOrder.length;
      db.ref(`rooms/${roomId}/game/turnIndex`).set(g.turnIndex);
    });
  };

}

initApp();
</script>
</body>
</html>
