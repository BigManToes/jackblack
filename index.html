<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JackBlack Multiplayer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: white;
      text-align: center;
      padding: 50px;
    }
    #game-message {
      margin-top: 20px;
      font-size: 20px;
    }
    #winner-message {
      margin-top: 10px;
      font-size: 28px;
      font-weight: bold;
      color: #ffd700;
    }
    #turn-indicator {
      margin-top: 10px;
      font-size: 22px;
      font-weight: bold;
      color: #ffd700;
    }
    .card {
      display: inline-block;
      margin: 10px;
      padding: 30px 40px;
      background-color: #f0f0f0;
      border-radius: 16px;
      color: black;
      font-size: 36px;
      font-weight: bold;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      border: 2px solid #ccc;
      min-width: 60px;
      min-height: 80px;
      user-select: none;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
    }
    #dealer-cards, #player-cards {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    input {
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>JackBlack Multiplayer</h1>
  <p>Join a room to play blackjack in real-time!</p>
  <div id="player-info"></div>
  <div id="players-voting"></div>
  <input id="room-id" placeholder="Enter Room ID" />
  <button onclick="joinRoom()">Join Room</button>
  <button onclick="voteToStart()" id="vote-button" style="display:none;">Vote to Start</button>
  <div id="turn-indicator"></div>
  <div id="controls" style="display:none;">
    <button onclick="hit()">Hit</button>
    <button onclick="stand()">Stand</button>
  </div>
  <div id="player-cards"></div>
  <div id="dealer-cards"></div>
  <div id="game-message"></div>
  <div id="winner-message"></div>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration (your original API keys)
    const firebaseConfig = {
      apiKey: "AIzaSyBVajydbsrNT6bJOCNMNjJZc4NXvGy42SQ",
      authDomain: "jackblack-789f5.firebaseapp.com",
      databaseURL: "https://jackblack-789f5-default-rtdb.firebaseio.com",
      projectId: "jackblack-789f5",
      storageBucket: "jackblack-789f5.firebasestorage.app",
      messagingSenderId: "14557094808",
      appId: "1:14557094808:web:252134996948616d95c1ed",
      measurementId: "G-89GFJPNWKH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomId = "";
    let playerId = "player" + Math.floor(Math.random() * 1000);
    let isPlayerTurn = false;

    function joinRoom() {
      roomId = document.getElementById("room-id").value.trim();
      if (!roomId) return alert("Enter room ID!");

      const playerRef = db.ref(`rooms/${roomId}/players/${playerId}`);
      playerRef.set({ joined: Date.now(), vote: false });
      playerRef.onDisconnect().remove();

      document.getElementById("controls").style.display = "block";
      document.getElementById("vote-button").style.display = "inline-block";
      listenForUpdates();
    }

    function listenForUpdates() {
      db.ref(`rooms/${roomId}/game`).on('value', snap => {
        const game = snap.val();
        if (!game) return;

        const playerHand = game.playerHands?.[playerId] || [];
        const dealerHand = game.dealerHand || [];
        isPlayerTurn = game.turn === playerId && !game.over;

        updateCards("player-cards", playerHand);

        // Show dealer's first card as hidden if game not over and dealer's turn hasn't started
        let showDealerHand = dealerHand;
        if (!game.over && game.turn !== "dealer") {
          showDealerHand = dealerHand.map((c, i) => i === 0 ? { v: "??", s: "?" } : c);
        }
        updateCards("dealer-cards", showDealerHand);

        document.getElementById("game-message").innerText = game.message || "";
        document.getElementById("winner-message").innerText = game.winnerMessage || "";
        document.getElementById("controls").style.display = isPlayerTurn ? "block" : "none";

        // Turn indicator
        let turnText = "";
        if (game.over) {
          turnText = "Game Over";
        } else if (game.turn === "dealer") {
          turnText = "It's the dealer's turn!";
        } else if (game.turn) {
          turnText = `It's ${game.turn}'s turn!`;
        }
        document.getElementById("turn-indicator").innerText = turnText;
      });

      db.ref(`rooms/${roomId}/players`).on('value', snap => {
        const players = snap.val() || {};
        const playerList = Object.keys(players).map(pid => {
          return `${pid} (${players[pid].vote ? "Voted" : "Not voted"})`;
        }).join(", ");
        document.getElementById("player-info").innerText = `Players: ${playerList}`;

        // Voting logic for any number of players (not just 2)
        const playerIds = Object.keys(players);
        const playerVotes = Object.values(players).filter(p => p.vote).length;
        document.getElementById("players-voting").innerText = `${playerVotes} out of ${playerIds.length} voted to start.`;

        if (playerIds.length >= 2 && playerVotes === playerIds.length) {
          // Only the player with the lowest playerId starts the game
          const sortedIds = playerIds.slice().sort();
          if (playerId === sortedIds[0]) {
            startGame(playerIds);
          }
        }
      });
    }

    function startGame(playerIds) {
      const suits = ['♠', '♣', '♦', '♥'];
      const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
      let deck = [];
      for (let s of suits) for (let v of values) deck.push({ v, s });
      deck = deck.sort(() => Math.random() - 0.5);

      // Randomize player order
      const shuffledIds = playerIds.slice().sort(() => Math.random() - 0.5);

      const gameState = {
        deck,
        playerHands: {},
        dealerHand: [],
        turn: shuffledIds[0],
        message: "Game started!",
        winnerMessage: "",
        players: {},
        stood: {},
        busted: {},
        over: false,
        playerOrder: shuffledIds
      };

      for (let pid of shuffledIds) {
        gameState.playerHands[pid] = [deck.pop(), deck.pop()];
        
        // Check for initial blackjack
        const score = calcScore(gameState.playerHands[pid]);
        if (score === 21) {
          gameState.message = `${pid} has blackjack (21)!`;
          gameState.winnerMessage = `🏆 ${pid} WINS WITH BLACKJACK! 🏆`;
          gameState.winner = pid;
          gameState.over = true;
        }
      }
      
      // Only deal dealer cards if no player has blackjack
      if (!gameState.over) {
        gameState.dealerHand = [deck.pop(), deck.pop()];
        
        for (let pid of shuffledIds) {
          gameState.players[pid] = { vote: true };
        }
      }

      db.ref(`rooms/${roomId}/game`).set(gameState);
      document.getElementById("vote-button").style.display = "none";
    }

    function voteToStart() {
      db.ref(`rooms/${roomId}/players/${playerId}`).update({
        vote: true
      });
      document.getElementById("vote-button").style.display = "none";
    }

    function updateCards(id, cards) {
      const div = document.getElementById(id);
      div.innerHTML = "";
      cards.forEach(card => {
        const el = document.createElement("div");
        el.className = "card";
        el.innerText = `${card.v} ${card.s}`;
        div.appendChild(el);
      });
    }

    function hit() {
      db.ref(`rooms/${roomId}/game`).once('value', snap => {
        const game = snap.val();
        if (game.turn !== playerId || game.over) return;

        // If player already stood or busted, do nothing
        if ((game.stood && game.stood[playerId]) || (game.busted && game.busted[playerId])) return;

        const deck = game.deck;
        const newCard = deck.pop();
        game.playerHands[playerId].push(newCard);

        const score = calcScore(game.playerHands[playerId]);
        
        // Check for bust immediately and announce it
        if (score > 21) {
          game.message = `${playerId} BUSTED with ${score}!`;
          game.busted = game.busted || {};
          game.busted[playerId] = true;
        } else if (score === 21) {
          game.message = `${playerId} hits 21!`;
          game.stood = game.stood || {};
          game.stood[playerId] = true;
          
          // Check if 21 is an instant win
          const allBustedExceptCurrent = Object.keys(game.playerHands)
            .filter(pid => pid !== playerId)
            .every(pid => (game.busted && game.busted[pid]) || 
                           (game.playerHands[pid] && calcScore(game.playerHands[pid]) < 21));
                           
          if (allBustedExceptCurrent) {
            game.winnerMessage = `🏆 ${playerId} WINS WITH 21! 🏆`;
            game.over = true;
            game.winner = playerId;
          }
        } else {
          game.message = `${playerId} hits. Score: ${score}`;
        }

        game.deck = deck;

        // Check if all players are done
        const allDone = Object.keys(game.playerHands).every(pid =>
          (game.stood && game.stood[pid]) ||
          (game.busted && game.busted[pid]) ||
          calcScore(game.playerHands[pid]) === 21
        );
        
        if (game.over) {
          db.ref(`rooms/${roomId}/game`).set(game);
        } else if (allDone) {
          game.turn = "dealer";
          game.message += " Dealer's turn!";
          db.ref(`rooms/${roomId}/game`).set(game);
          setTimeout(() => dealerPlay(), 500);
        } else {
          const nextPlayer = getNextPlayer(game, playerId);
          if (nextPlayer) {
            game.turn = nextPlayer;
          }
          db.ref(`rooms/${roomId}/game`).set(game);
        }
      });
    }

    function stand() {
      db.ref(`rooms/${roomId}/game`).once('value', snap => {
        const game = snap.val();
        if (game.turn !== playerId || game.over) return;

        // If player already stood or busted, do nothing
        if ((game.stood && game.stood[playerId]) || (game.busted && game.busted[playerId])) return;

        game.message = `${playerId} stands.`;
        game.stood = game.stood || {};
        game.stood[playerId] = true;

        // Check if all players are done
        const allDone = Object.keys(game.playerHands).every(pid =>
          (game.stood && game.stood[pid]) ||
          (game.busted && game.busted[pid]) ||
          calcScore(game.playerHands[pid]) === 21
        );
        
        if (allDone) {
          game.turn = "dealer";
          game.message += " Dealer's turn!";
          db.ref(`rooms/${roomId}/game`).set(game);
          setTimeout(() => dealerPlay(), 500);
        } else {
          const nextPlayer = getNextPlayer(game, playerId);
          if (nextPlayer) {
            game.turn = nextPlayer;
          }
          db.ref(`rooms/${roomId}/game`).set(game);
        }
      });
    }

    function getNextPlayer(game, currentId) {
      const playerIds = game.playerOrder || Object.keys(game.playerHands);
      const idx = playerIds.indexOf(currentId);
      for (let i = 1; i < playerIds.length; i++) {
        const nextIdx = (idx + i) % playerIds.length;
        const nextId = playerIds[nextIdx];
        if (
          !(game.busted && game.busted[nextId]) &&
          !(game.stood && game.stood[nextId]) &&
          calcScore(game.playerHands[nextId]) < 21
        ) {
          return nextId;
        }
      }
      return null;
    }

    function dealerPlay() {
      db.ref(`rooms/${roomId}/game`).once('value', snap => {
        const game = snap.val();
        if (!game || game.over) return;

        let dealerHand = game.dealerHand || [];
        let deck = game.deck || [];
        let dealerScore = calcScore(dealerHand);

        // Dealer hits until 17 or more
        while (dealerScore < 17) {
          const newCard = deck.pop();
          dealerHand.push(newCard);
          dealerScore = calcScore(dealerHand);
        }

        game.dealerHand = dealerHand;
        game.deck = deck;
        game.over = true;

        // Get game results
        const results = determineWinner(game);
        game.message = results.message;
        game.winnerMessage = results.winnerMessage;
        game.winner = results.winner;

        db.ref(`rooms/${roomId}/game`).set(game);
      });
    }

    function determineWinner(game) {
      const dealerScore = calcScore(game.dealerHand);
      let dealerBusted = dealerScore > 21;
      
      let message = `Dealer's score: ${dealerScore}${dealerBusted ? " (BUSTED)" : ""}. `;
      let winnerMessage = "";
      let winner = null;
      
      // First check if anyone hit 21 exactly
      for (const pid of game.playerOrder || Object.keys(game.playerHands)) {
        const score = calcScore(game.playerHands[pid]);
        if (score === 21 && !(game.busted && game.busted[pid])) {
          winner = pid;
          winnerMessage = `🏆 ${pid} WINS WITH 21! 🏆`;
          break;
        }
      }
      
      // If no one hit 21, find highest score that's not busted
      if (!winner) {
        let highestScore = dealerBusted ? 0 : dealerScore;
        let highestPlayer = dealerBusted ? null : "dealer";
        
        for (const pid of game.playerOrder || Object.keys(game.playerHands)) {
          const score = calcScore(game.playerHands[pid]);
          if (score <= 21 && score > highestScore && !(game.busted && game.busted[pid])) {
            highestScore = score;
            highestPlayer = pid;
          }
        }
        
        if (highestPlayer && highestPlayer !== "dealer") {
          winner = highestPlayer;
          winnerMessage = `🏆 ${highestPlayer} WINS WITH ${highestScore}! 🏆`;
        } else if (highestPlayer === "dealer") {
          message += "Dealer wins!";
        } else {
          message += "Everyone busted! No winner.";
        }
      }
      
      // List busted players
      const bustedPlayers = [];
      for (const pid of game.playerOrder || Object.keys(game.playerHands)) {
        if (game.busted && game.busted[pid]) {
          bustedPlayers.push(`${pid}`);
        }
      }
      
      if (bustedPlayers.length > 0) {
        message += `BUSTED: ${bustedPlayers.join(", ")}. `;
      }
      
      return {
        message,
        winnerMessage,
        winner
      };
    }

    function calcScore(hand) {
      let score = 0, aces = 0;
      hand.forEach(c => {
        if (['J','Q','K'].includes(c.v)) score += 10;
        else if (c.v === 'A') { score += 11; aces++; }
        else score += parseInt(c.v);
      });
      while (score > 21 && aces--) score -= 10;
      return score;
    }
  </script>
</body>
</html>
